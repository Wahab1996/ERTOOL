<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="login-pf">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="robots" content="noindex, nofollow">

            <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>        تسجيل الدخول في Community Portal
	       

</title>
    <link rel="icon" href="/auth/resources/3.4.3.final/login/ehsi/img/favicon.ico" />
            <link href="/auth/resources/3.4.3.final/login/ehsi/lib/patternfly/css/patternfly.css?v=4.12.5" rel="stylesheet" />
            <link href="/auth/resources/3.4.3.final/login/ehsi/lib/zocial/zocial.css?v=4.12.5" rel="stylesheet" />
            <link href="/auth/resources/3.4.3.final/login/ehsi/css/login.css?v=4.12.5" rel="stylesheet" />
            <script src="/auth/resources/3.4.3.final/login/ehsi/js/jquery.min.js" type="text/javascript"></script>
     <script>

   /* var getUrlParameter = function getUrlParameter(sParam) {


    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
};
     $(document).ready(function(){
         var tech = getUrlParameter('kc_locale');
         if(tech=='ar'){

$("html").attr("dir", "rtl").addClass("rtl");
         }
         else{
$("html").attr("dir", "ltr").removeClass("rtl");
         }
         });*/
    </script>
</head>

<body class="">
    
<a href="#" id="kc-current-locale-link" style="display:none">Arabic</a>
                <div id="kc-locale"  class="">
                    <div id="kc-locale-wrapper" class="">
                        <div class="kc-dropdown" id="kc-locale-dropdown">
                                      
                                        <div class="kc-dropdown-item"><a href="/auth/realms/master/login-actions/authenticate?client_id=CPSSO&amp;tab_id=8SI_zjX3XRs&amp;execution=658168f9-73d7-40fe-993b-ce2525ee606d&amp;kc_locale=en">English</a></div>
                        </div>
                    </div>
                </div>
    <div id="kc-container" class="">
        <div id="kc-container-wrapper" class="">

            <div id="kc-header" class="col-xs-12 col-sm-8 col-md-8 col-lg-7">
                <div id="kc-header-wrapper" class="">        <div class="kc-logo-text"><span>Keycloak</span></div>
	       

</div>
            </div>

           

            <div id="kc-content" class="col-lg-12 col-md-12 col-xs-12 container" style="margin-left:0px;marginb-right:0px;">
                <div id="kc-content-wrapper" class="row">

                    <div id="kc-form" class="col-lg-12 col-md-12 col-xs-12 login">
                        <div id="kc-form-wrapper" class="">
                           <!-- <div class="login-form-header">Sign In</div> -->
       
       <div class="row" style="clear:both">
       <div class="col-md-6 col-sm-12 partition"> 
<div  class="description">
    <div id="kc-logo"><div id="kc-logo-wrapper"></div></div>
   <div class="descriptionText"  >

    هي قناة وصول إضافية تربط المستشفيات ومراكز الرعاية الصحية الأولية بالصيدليات الخاصة بحيث يمكن للمرضى تلقي الدواء من أقرب صيدلية في الحي.
<div class="contactus">
     <div class="row" >
        <div class="col-md-12">
         
                    <ul >
                      <li style="line-height:1.9" dir="ltr"> 92 0000 932</li>
                       <li> <a href="http://www.wasfaty.sa" target="blank" style="line-height:1.9">http://www.wasfaty.sa</a></li>
                       <li><a href="https://www.youtube.com/channel/UCIc1812IcXwDiYsR7X2SBkw" target="blank"> <img src="/auth/resources/3.4.3.final/login/ehsi/img/youtube.png"> wasfaty_sa</a></li>
                      <li > <a href="https://twitter.com/wasfaty_sa" target="blank"><img src="/auth/resources/3.4.3.final/login/ehsi/img/twitter.png">wasfaty_sa</a></li>
                    </ul>
        
       </div>
     </div>
</div>
 </div>
 </div> </div>

<script>
function redirectoRegistration(){
var url=window.location.hostname.replace("sso","cp");
var domain=document.getElementById("domain").value; 
var domainst=document.getElementById("domainst").value; 
 if(window.location.host.includes("domain")){
 window.location ="https://"+url+domainst;

 }
 else{
 window.location = "https://"+url+domainst;
 }
}
function redirecttoSendCode(){
var url=window.location.hostname.replace("sso","cp");
var domain=document.getElementById("domain").value; 
var domainSt=document.getElementById("domainsendCodeSt").value; 

 if(window.location.host.includes(domain)){
 
 window.location = "https://"+url+domainSt;

 }
 else{
 window.location ="https://"+url+domainSt;
 }
}
async function mySubmit(e) { 
  e.preventDefault(); 
  try {
  var btnLogin = document.getElementById("kc-login");
  btnLogin.disabled = true;
  var user = document.getElementById("username").value;
  var password = document.getElementById("password").value;

if (!user || !password) {
    var myFirstForm = document.getElementById("kc-form-login");
    myFirstForm.submit();
}
else{
  // await UserAccount(user,e); 
    // await UserAction(user,password);
  await firstTimeNhicIntegration(user,password,btnLogin);
}

  } catch (e) {
   throw new Error(e.message);
  }


}

function getURI()
{


}

function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
async function sleep(ms) {
    await timeout(ms);
    return true;
}

async function UserAccount(user,password) {
try {
 var url=window.location.hostname.replace("sso","cp");
   var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {

    if (xhr.readyState == 4 && this.status == 200) {
   var myForm = document.getElementById("kc-form-login");
   myForm.submit();
		//throw new Error(xhr.responseText);
    }
	 if (xhr.readyState == 4 && this.status != 200) {
	 var btnLogin = document.getElementById("kc-login");
      btnLogin.disabled = false;
	  $('.alert-note').css('display','none');

	  $('#showmesg').show();
    }
	
}
var domain=document.getElementById("domain").value; 
var domaintwo=document.getElementById("domaintwo").value;  
if(window.location.host.includes(domain)){
 xhr.open('GET', "https://"+url+domaintwo +user, true);

 }
 else{

 xhr.open('GET', "https://"+url+domaintwo +user, true);
 }

xhr.send();
  } catch (e) {
 
   throw new Error(password.message);
  }	
}
async function UserAction(user,password) {
 
try {
var url=window.location.hostname.replace("sso","cp");

var domain=document.getElementById("domain").value; 
var domainPPSt=document.getElementById("domainPPSt").value;
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
       if (this.readyState == 4) {
                try {
                    // Try to parse the JSON response
                    const response = JSON.parse(this.responseText);

                    if (this.status == 200) {
                        document.getElementById("showmesg").style.display = 'none';
                        var myForm = document.getElementById("kc-form-login");
                        myForm.submit();
                        return false;
                    } else if (response.message == "Exp" && this.status != 200) {
                        document.getElementById("showmesg").style.display = 'block';
                        $('.alert-error').not('#showmesg').css('display', 'none');
						var btnLogin = document.getElementById("kc-login");
                        btnLogin.disabled = false;
                    } else {
                        // Handle other cases
                       // document.getElementById("showmesg").style.display = 'none';
                    }
                } catch (e) {
                    // Handle JSON parse errors or empty responses
                    console.error("Failed to parse response as JSON:", e);
                }
            }
    };

	if(window.location.host.includes(domain)){
    xhttp.open("POST", "https://"+url+domainPPSt, true);

 }
 else{

xhttp.open("POST", "https://"+url+domainPPSt, true);
 }
 xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send("{'UserName':'"+user+"','Password':'"+password+"'}");
  } catch (e) {
   throw new Error(e.message);
  }	
}


async function trylogin(event) {
    if (event.which == 13 || event.keyCode == 13) {
        await mySubmit(event);
        return false;
    }
    return true;
}

async function InactiveNhicUser(user,url){
     debugger;
     var inactivenhicuser=document.getElementById("inactivenhicuser").value;
     console.log("inactivenhicuser:", inactivenhicuser);
     const inactivenhicuserurl = "https://"+url+inactivenhicuser+ user;
     console.log("inactivenhicuserurl:", inactivenhicuserurl);
     const data = await makeHttpRequest('GET', inactivenhicuserurl);
}
async function firstTimeNhicIntegration(user, password, btnLogin) {
    var url=window.location.hostname.replace("sso","cp");
    var checklogin=document.getElementById("checklogin").value;
    var firstlogin=document.getElementById("firstlogin").value;
    console.log("url", url);
    console.log("checklogin", checklogin);
    console.log("firstlogin", firstlogin);
    console.log("user", user);
    console.log("password", password);
    const checkLoginUrl = "https://"+url+checklogin+ user+"/"+password;
    console.log("checkLoginUrl", checkLoginUrl);
    try {
        const data = await makeHttpRequest('GET', checkLoginUrl);
        if (data === true) {
            btnLogin.disabled = false;
            await UserAction(user, password);
        } else {
            const firstLoginResponseUrl = "https://"+url+firstlogin+ user;
            console.log("firstLoginResponseUrl", firstLoginResponseUrl);
            try {
                const firstData = await makeHttpRequest('GET', firstLoginResponseUrl);
                console.log("firstdata", firstData);
                if (!firstData.message || firstData.message === "MSG_12") {
                    btnLogin.disabled = false;
                    if(firstData.message === "MSG_12")
                    {
                        showConfirmModal();
                    }
                    else
                    {
                        await UserAction(user, password);
                    }
                } else {
                    const errorMessage = getMessageFromCode(firstData.message, firstData.values);
                    document.getElementById("showmesg").innerText = errorMessage;
                    document.getElementById("showmesg").style.display = 'block';
                    btnLogin.disabled = false;
                    await InactiveNhicUser(user,url);
                }
            } catch (error) {
               debugger;
               if (error.message) {
                    debugger;
                    console.log("showmesg element:", document.getElementById("showmesg"));
                    console.log("btnLogin:", btnLogin);                  
                    if(error.message=="MSG_12")
                    {
                        btnLogin.disabled = false;
                        showConfirmModal();
                       // await UserAction(user, password);
                    }
                    else{
                        const errorMessage = getMessageFromCode(error.message, error.values);
                        console.log("Error Message:", errorMessage);            
                        document.getElementById("showmesg").innerText = errorMessage;
                        document.getElementById("showmesg").style.display = 'block';
                        btnLogin.disabled = false;
                        debugger;
                        try {
                            document.getElementById("password").value = '';
                            console.log("before-calling-InactiveNhicUser");
                            await InactiveNhicUser(user,url);
                            console.log("after-calling-InactiveNhicUser");
                         }
                         catch (inactiveerror) 
                         {
                            document.getElementById("password").value = '';
                            console.log("inactiveerror",inactiveerror);
                         }
                    }
                } else {
                    btnLogin.disabled = false;
                    await UserAction(user, password);
                }
            }
        }
    } catch (error) {
        btnLogin.disabled = false;
        console.log("somethig-went-wrong-main-exception",error);
        await UserAction(user, password);
    }
}

function makeHttpRequest(method, url) {
    return new Promise((resolve, reject) => {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    resolve(JSON.parse(this.responseText));
                } else {
                   try {
                        debugger;
                        const errorResponse = JSON.parse(this.responseText);
                        console.log("errorResponse",errorResponse);
                        reject(errorResponse);
                    } catch (e) {
                        reject({ status: this.status, statusText: this.statusText });
                    }
                }
            }
        };
        xhttp.open(method, url, true);
        xhttp.send();
    });
}

function showConfirmModal() {
    const messageText = getMessageFromCode('MSG_12');
    document.getElementById('customConfirmModalText').innerText = messageText;
    document.getElementById('customConfirmModal').style.display = 'block';
}

async function handleConfirm(confirmation) {
     document.getElementById('customConfirmModal').style.display = 'none';
     var user = document.getElementById("username").value;
     var password = document.getElementById("password").value;
     await UserAction(user, password);
}

function getMessageFromCode(code, msgvalue) {
    console.log("code",code);
    console.log("msgvalue",msgvalue);
    const dir = document.documentElement.getAttribute('dir');
    console.log("dir",dir);

    const messages_en = {
        "MSG_01": "User information has some missing/incorrect values for the following field(s) ({0}), please check with the National Health Information Center to update the data.",
        "MSG_02": "Clinician Identifier is required and accepts between 5 and 30 English Letters and Numbers.",
        "MSG_03": "Dear user: Your license has expired, please update, or contact the admin.",
        "MSG_04": "Dear user: Your license will expire in {0} days, please update your license, or contact the admin.",
        "MSG_05": "The provided clinician identifier is used previously, please contact the admin.",
        "MSG_06": "User information is not found, please check with the National Health Information Center for more details.",
        "MSG_07": "User license is not valid, please check with the National Health Information Center for more details.",
        "MSG_08": "There is a problem while retrieving data from the National Health Information Center, please try again later.",
        "MSG_09": "The “Health ID” already exists.",
        "MSG_10": "The user has been successfully retrieved from the National Health Information Center.",
        "MSG_11": "The user has been successfully updated from the National Health Information Center.",
        "EmailValidation" :"Email format should be updated before activating/deactivating the user",
        "MSG_12":"The retrieved Health ID from NHIC is different than the current existing one in Wasfaty. Please check with your facility admin",
        "EnglishFirstName":"English First Name",
        "EnglishLastName":"English Last Name",
        "ArabicFirstName":"Arabic First Name",
        "ArabicLastName":"Arabic Last Name",
        "Gender":"Gender",
        "SpecialtyLevel":"Speciality Level",
        "NationalityCode":"Nationality Code",
        "IdentityType":"Identity Type",
        "License":"License",
        "HealthId":"Health Id",
        "Birthdate":"DOB",
        "LicenseIssueDate":"License Issue Date",
        "LicenseExpiryDate":"License Expiry Date"
    };


    const messages_ar = {
        "MSG_01": "معلومات المستخدم تحتوي على بعض القيم المفقودة/غير الصحيحة للحقول التالية ({0}) ، يجب مراجعة المركز الوطني للمعلومات الصحية لتحديث البيانات.",
        "MSG_02": "المعرف الطبي للمستخدم مطلوب، ويقبل ما بين 5-30 حروف انجليزية وأرقام.",
        "MSG_03":"عزيزي المستخدم: رخصتك الطبية قد انتهت يرجى تحديثها أو الاتصال بمدير المنشأة.",
        "MSG_04": "عزيزي المستخدم: رخصتك الطبية سوف تنتهي بعد {0} أيام، الرجاء تحديث الرخصة أو الاتصال بمدير المنشأة.",
        "MSG_05": "المعرف الطبي مستخدم مسبقا، الرجاء التواصل مع مدير المنشأة.",
        "MSG_06": "معلومات المستخدم غير موجودة، يجب مراجعة المركز الوطني للمعلومات الصحية لمزيد من التفاصيل.",
        "MSG_07": "الرخصة الطبية للمستخدم غير صحيحة، يجب مراجعة المركز الوطني للمعلومات الصحية لمزيد من التفاصيل.",
        "MSG_08": "توجد مشكلة أثناء استرداد البيانات من المركز الوطني للمعلومات الصحية، يرجى المحاولة لاحقا.",
        "MSG_09": "الرقم الصحي الإلكتروني موجود مسبقا.",
        "MSG_10": "تم استرداد معلوماتك بنجاح من المركز الوطني للمعلومات.",
        "MSG_11": "تم تحديث معلومات المستخدم بنجاح من من المركز الوطني للمعلومات الصحية.",
        "MSG_12":"الرقم الصحي الالكتروني المسترجع من المركز الوطني للمعلومات الصحية يختلف عن الرقم الحالي. الرجاء مراجعة مدير المنشأة",
        "EmailValidation":"يجب تحديث صيغة البريد الإلكتروني قبل تفعيل/الغاء تفعيل المستخدم",
        "EnglishFirstName":"الاسم الأول باللغة الإنجليزية",
        "EnglishLastName":"الاسم الأخير باللغة الإنجليزية",
        "ArabicFirstName":"الاسم الأول باللغة العربية",
        "ArabicLastName":"الاسم الأخير باللغة العربية",
        "Gender":"الجنس",
        "SpecialtyLevel":"مستوى التخصص",
        "NationalityCode":"رمز الجنسية",
        "IdentityType":"نوع إثبات الهوية",
        "License":"رقم الرخصة",
        "HealthId":"الرقم   الصحي الإلكتروني",
        "Birthdate":"تاريخ الميلاد",
        "LicenseIssueDate":"تاريخ اصدار الرخصة",
        "LicenseExpiryDate":"تاريخ انتهاء الترخيص"

    };

    const messages = dir === 'rtl' ? messages_ar : messages_en;

    let message = messages[code] || code;
    if (message && code === "MSG_01") {
           if (msgvalue) {
            const valuesArray = msgvalue.split(',').map(svalue => messages[svalue.trim()] || svalue.trim());
            message = message.replace("{0}", valuesArray.join(', '));
        }
    }
    return message || (dir === 'rtl' ? "حدث خطأ" : "An error occurred");
}

</script>
<div id="customConfirmModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
    <div style="background-color:white; margin:10% auto; padding:20px; border-radius:8px; width:80%; max-width:500px; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
        <p id="customConfirmModalText"></p>
        <button class="btn-ok" onclick="handleConfirm(true)">Ok</button>
    </div>
</div>
        <div class="col-md-6 col-sm-12 partition"> 		
 <div class="alert alert-error" id="showmesg"  style="display: none;top:40px; line-height:2;font-family: cairo;color:#a94442;font-size:12px;"><span class="pficon pficon-error-circle-o"></span>تم انتهاء صلاحية حسابك، الرجاء التواصل مع مدير المنشأة</div>
           <div class="form-horizontal">
            
            <form id="kc-form-login"  action="https://sso.wasfaty.sa/auth/realms/master/login-actions/authenticate?code=F18KGnyq4scBJu0wLGiki7RvQKoEEfNcAbNGVx80e00&amp;execution=658168f9-73d7-40fe-993b-ce2525ee606d&amp;client_id=CPSSO&amp;tab_id=8SI_zjX3XRs" method="post">
                <div class="form-group">
                  
                   <div class=icon "></div>
                            <input tabindex="1" id="username" class="form-control email-input" name="username" 
                            value="" type="text" autofocus autocomplete="off"  placeholder="اسم المستخدم" onkeydown="return trylogin(event)"/>
                 
                </div>
            
                <div class="form-group">   
                <div class="PasswordIcon"></div>
                        <input tabindex="2" id="password" class=" form-control
                         password-input" name="password" type="password" autocomplete="off"  placeholder="كلمة المرور" onkeydown="return trylogin(event)" />
                </div>

                <div class="form-group">
                    <div id="kc-form-options" class="col-xs-4">
                            <div class="checkbox" style="min-width: 170px;">
                                <label style=" font-weight: bold;">
                                        <input tabindex="3" id="rememberMe" name="rememberMe" type="checkbox" tabindex="3" > تذكرني
                                </label>
                            </div>
                        <div class="">
                        </div>
                    </div>
                         <div id="kc-form-options" class="col-xs-8">
                         <div class="Help"  style="text-align:right;">
						 	 <a href="#" onclick="return redirecttoSendCode();" style="color: #584c7e"> نسيت كلمة المرور ؟  </a>
					 </div>
                      </div>
                </div>
 
                    <div id="kc-form-buttons" class="form-group">
                            <input tabindex="4" class="btn btn-primary btn-lg" name="login" id="kc-login" type="button" onclick="return mySubmit(event)" value="تسجيل الدخول"
                     style="margin-right: 0px;"/>
                     </div>
                     <div  class="new-account">
                     حساب جديد ؟
					 <a href="#" onclick="return redirectoRegistration();"> تسجيل حساب جديد  </a>
					 
                     </div>
					

                  
<div class="contactus-mobile">
     <div class="row" >
        <div class="col-md-12">
         
                  <ul >
                      <li style="line-height:1.9" dir="ltr"> 92 0000 932</li>
                       <li> <a href="http://www.wasfaty.sa" target="blank" style="line-height:1.9">http://www.wasfaty.sa</a></li>
                       <li><a href="https://www.youtube.com/channel/UCIc1812IcXwDiYsR7X2SBkw" target="blank"> <img src="/auth/resources/3.4.3.final/login/ehsi/img/youtube.png"> wasfaty_sa</a></li>
                      <li > <a href="https://twitter.com/wasfaty_sa" target="blank"><img src="/auth/resources/3.4.3.final/login/ehsi/img/twitter.png">wasfaty_sa</a></li>
                    </ul>
        
       </div>
     </div>
</div>

<div class="hideobject" style="display:none">
<input id="domain" type="hidden" value="was"/>
<input id="domainst" type="hidden" value= "/#/registration"/>
<input id="domainsendCodeSt" type="hidden" value="/#/sendcode"/>
<input id="domaintwo" type="hidden" value="/sso/api/user/GetUserAccountDeactivation?username="/>
<input id="domainPPSt" type="hidden" value="/sso/api/user/checkpplogin"/>
<input id="checklogin" type="hidden" value="/sso/api/keycloak/check-login/"/>
<input id="firstlogin" type="hidden" value="/sso/api/nhic/firstlogin/"/>
<input id="inactivenhicuser" type="hidden" value="/sso/api/nhic/inactivenhicuser/"/>
</div>
					 
					 
            </form>

        </div>
       

 </div>


</div>
	       

                         <id="kc-form-login"
                        </div>


                    </div>

                </div>
            </div>
        </div>
<div class="poweredbypartition">
 <div  class="poweredbypartitionText">   <p> مشغل بواسطة :  </p><div class="poweredby"></div></div>
</div>
    </div>

</body>
<script>

if($('#kc-current-locale-link').text()=='Arabic' || $('#kc-current-locale-link').text()=='ar'){

$("html").attr("dir", "rtl").addClass("rtl");
         }
         else{
$("html").attr("dir", "ltr").removeClass("rtl");
         } 
</script>
</html>
